
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xml:lang="en" lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Page-Enter" content="blendTrans(Duration=2)" />
<meta http-equiv="Site-Exit" content="blendTrans(Duration=5)" />



<link rel="stylesheet" type="text/css" href="Main.css" />
<link rel="stylesheet" type="text/css" href="Position.css" />
<link rel="stylesheet" type="text/css" href="Menu.css" />
<link rel="stylesheet" type="text/css" href="Other.css" />

<link rel="stylesheet" type="text/css" href="SliderHorizontal.css" />
<link rel="stylesheet" type="text/css" href="SliderVertical.css" />
<link rel="stylesheet" type="text/css" href="ChoiceBoxHoriz.css" />
<link rel="stylesheet" type="text/css" href="Transceiver.css" />
<link rel="stylesheet" type="text/css" href="TabMenu.css" />

<script src="jquery.js"></script>
<script src="jquery.populate.pack.js"></script>
<script type="text/javascript" src="json2.js"></script>
<script type="text/javascript" src="SignalEmulator.js"></script>
<script type="text/javascript" src="SliderHorizontal.js"></script>
<script type="text/javascript" src="SliderVertical.js"></script>
<script type="text/javascript" src="ChoiceBoxHoriz.js"></script>
<script type="text/javascript" src="ChoiceBoxHoriz2.js"></script>

<script type="text/javascript" src="Menu.js"></script>
<script type="text/javascript" src="MenuVertical.js"></script>
<script type="text/javascript" src="MenuHorizontal.js"></script>
<script type="text/javascript" src="MenuItem.js"></script>
<script type="text/javascript" src="Range.js"></script>
<script type="text/javascript" src="Light.js"></script>
<script type="text/javascript" src="TimeScale.js"></script>
<script type="text/javascript" src="data.js"></script>
<script type="text/javascript" src="Alarm.js"></script>
<script type="text/javascript" src="NmeaList.js"></script>
<script type="text/javascript" src="TabMenu.js"></script>
<script type="text/javascript" src="TabMenuItem.js"></script>
<script type="text/javascript" src="Transceiver.js"></script>
<script type="text/javascript" src="TransceiverTabMenu.js"></script>



<!-- """"""""""""""""""""""""""""""""""""""""""""""""""""""""" -->
<script type="text/javascript" src="swfobject.js"></script>
<script type="text/javascript" src="web_socket.js"></script>
<!-- """"""""""""""""""""""""""""""""""""""""""""""""""""""""" -->

<script src="EchoPainter.js"></script>
<script src="Scope.js"></script>


<title>Skippers</title>

<script type="text/javascript" charset="UTF-8">
	//ISO-8859-1">
	WEB_SOCKET_SWF_LOCATION = "WebSocketMain.swf";
	var conn = {};
	var echoWebSock; //echo sounder data
	var dataWebSock; // set-get data (e.q. GAIN, TVG...)

	var oldRange = 0;
	var currRange = 0;

	var currTimeScale = 0;

	var echoCanvas1;
	var echoCanvas1_x = 0;
	var echoCanvas1_y = 0;
	var echoCanvas2;
	var scopeCanvas;
	var scopeVisible = false;
	
	var CANVAS_WIDTH = 556;
	var CANVAS_HEIGHT = 400;
	
	var dataReceived = 0;
	var newColorArrayCh1;
	var newColorArrayCh2;
	var canvasWidth = CANVAS_WIDTH;
	var canvasHeight = CANVAS_HEIGHT;

	var chan = 1;

	window.onload = initEchoPainting;

	function initEchoPainting() {
		scopeCanvas = new Scope(0, 0, 400, 256);
		initOneCanvas();
		//startDataProviderTimer();*/
		startPaintingCanvasTimer();
		
	}

	function initOneCanvas() {
		echoCanvas1 = new EchoCanvas(echoCanvas1_x, echoCanvas1_y, canvasWidth, canvasHeight);
		echoCanvas2 = null;
		//echoCanvas1.resize(400, 0, 150, 450);
	}

	function initBothCanvas() {
		echoCanvas1 = new EchoCanvas(0, 0, 450, canvasHeight);
		echoCanvas2 = new EchoCanvas(450, 0, 450, canvasHeight);
	}
	
	function changeToScopeScreen() {
		scopeVisible = true;
		canvasWidth = 150;
		echoCanvas1.resize(406, 0, canvasWidth, canvasHeight);
	}
	
	function changeToEchoScreen() {
		scopeVisible = false;
		canvasWidth = CANVAS_WIDTH;
		canvasHeight = CANVAS_HEIGHT;
		echoCanvas1.resize(0, 0, canvasWidth, canvasHeight);
	}

	//////////////////////////////////////////////////
	//TIMER USED FOR ECHO PAINTING USING CANVAS
	//////////////////////////////////////////////////
	function startPaintingCanvasTimer() {
		t = setTimeout("onPaintingCanvasTimer()", startSleepTime + sleepCoef
				* 100); //300);
	}

	function onPaintingCanvasTimer() {
		if (dataReceived > 0) {
			if (scopeVisible)
				scopeCanvas.paint();
			echoCanvas1.echoPainter_PaintCanvas();
			if (echoCanvas2 != null)
				echoCanvas2.echoPainter_PaintCanvas();
		}
		startPaintingCanvasTimer();
	}

	//////////////////////////////////////////////////
	// TIMER USED FOR GETING OF SENSOR DATA FROM 
	// THE WEB SERVER.
	//////////////////////////////////////////////////
	/*function startDataProviderTimer() {
		t = setTimeout("onDataProviderTimer()", 1000);
	}

	////////////////////////////////////////////////
	// Get echo data from php
	////////////////////////////////////////////////
	function onDataProviderTimer() {
		$.get("dataProvider.php", // calling php
		{
			type : 1, // echo = 1, ...
			chan : chan, // 1 when 1 channel requested. 2 for 2 chanels
			range : currRange
		//
		}, // parameter to send
		function(data) { // callback function
			parseEchoData(data);
			//alert("ajax callback");
			//$('#timeval').html(data); // don't remove. It displays received message
		}

		); // end of "$get"

		startDataProviderTimer();
		///////////////////////////////////////////////
		// Don't remove: The same using jquery function "load"
		///////////////////////////////////////////////
		//$('#timeval').load('dataProvider.php?randval='+ Math.random());
	}*/

	/* !!! DON*T REMOVE THIS
	// some of sliders is moved. 
	function onSliderMoved(sliderIndex, pos) {
		pos = parseInt(pos / 10);
		if (pos > 5)
			pos = 5;
		
		

		if (sliderIndex == 2){
			reconnectSocket();
		} else if (sliderIndex == 3){
			changeTimeRange(pos);
		} else if (sliderIndex == 4) {
			sendToServer("R" + pos);
		}
	}
	 */
	////////////////////////////////////////////////
	// Parse echo data received from server
	////////////////////////////////////////////////
	function parseEchoData(data) {
		if (data.charAt(0) == '1') { //MSG TYPE = ECHO_
			var range = data.charAt(1);

			if (currRange != range) {
				oldRange = currRange;
				currRange = range;
				echoCanvas1.paintChangedRange(oldRange);
				changeRange(currRange);
			}


			var chanelsArray = data.substring(2).split("CH"); // NOT USED YET
			newColorArrayCh1 = chanelsArray[0].split(",");
			if (chanelsArray.length > 1) // NOT USED, ALWAYS = 1
				newColorArrayCh2 = chanelsArray[1].split(",");
			
			var buttom = newColorArrayCh1[0];
			document.getElementById("depth").innerHTML = "" + buttom + "m";
			
			dataReceived = 1;
			alarmTest(buttom);
			
			if (scopeVisible)
				scopeCanvas.setNewData(newColorArrayCh1);
			echoCanvas1.setNewData(newColorArrayCh1);
			if (echoCanvas2 != null)
				echoCanvas2.setNewData(newColorArrayCh2);
			//startDataProviderTimer(); // if you start timer from here, it will take 500ms (timer time) + around 500ms for sending/receiving of data
		}
		//updateSigBeam();
	}
	
	
	function parseRecData(data){
		var recJson = JSON.parse(data); /*, reviver);*/
		//jsonDATA = JSON.parse(data); /*, reviver);*/
		if (recJson.type == "sig") {
			jsonDATA = recJson;
			setSignalData();
		} else if (recJson.type == "top") {
			jsonTOP  = recJson;
			$('#tableTest').populate(jsonTOP.ins); //{'time':'12.22.12','gps':"11111",'speed':'144','frq':'100kHz'});		
		}	else if (recJson.type == "nmea") {
			jsonNmea = recJson;
			if (getListCount() > 20) {
				removeOptionFirst();
			}
			//TODO: if 
			
			
			if(jsonNmea.dir == jsonIO.set[selectedIO_source-1].disRadio.dis ) // if msg direction is OUT and display chois is OUT or if msg direction is IN and ...
				appendOptionLast(jsonNmea.nmea);
			//document.getElementById("gps").innerHTML = jsonNmea.nmea;
		} else if (recJson.type == "ioAll") {
			jsonIO  = recJson;	
		}
	}
	
	function sendToServer(msgToServer) {
		dataWebSock.send(msgToServer);// + "\n");
	}
	
	
</script>
</head>

<body>
	<div id="wrap">
		<div id="container">

			<div class="northsidebar">
			<div name="tableTest" id="tableTest" style="width:500px">
				<div class="topField" style="width:70px"><div class="topFieldTextLeft">TIME</div><div class="topFieldDown" id="time"></div></div>
				<div class="topField" style="width:100px"><div class="topFieldTextLeft">GPS</div><div class="topFieldDownLine1" id="gpsN">N 32 4334</div><div class="topFieldDownLine2" id="gpsE">E 33 44 5433</div></div>
				<div class="topField" style="width:70px"><div class="topFieldTextLeft">SPEED</div><div class="topFieldTextRight">[m/s]</div><div class="topFieldDown" id="speed"></div></div>
				<div class="topField" style="width:70px"><div class="topFieldTextLeft">TIME</div><div class="topFieldDown" id="time1"></div></div>
				<div class="topField" style="width:100px"><div class="topFieldTextLeft">GPS</div><div class="topFieldDown" id="gps"></div></div>
				<div class="topField" style="width:70px"><div class="topFieldTextLeft">SPEED</div><div class="topFieldTextRight">[m/s]</div><div class="topFieldDown" id="speed1"></div></div>
				<div class="topField" style="width:70px"><div class="topFieldTextLeft">TIME</div><div class="topFieldDown" id="time2"></div></div>
				<div class="topField" style="width:100px"><div class="topFieldTextLeft">GPS</div><div class="topFieldDown" id="gps2"></div></div>
				<div class="topField" style="width:70px"><div class="topFieldTextLeft">SPEED</div><div class="topFieldTextRight">[m/s]</div><div class="topFieldDown" id="speed2"></div></div>
			</div>
			<!-- 
			<table name="tableTest" id="tableTest">
				<tr><td>GPS:</td><td>Picture speed:</td><td >Frq:</td></tr>
				<tr><td id="gps"></td><td id="speed"></td><td id="frq"></td></tr>
			</table>
			
			 -->
				<div id="boatDiv"></div>
				<div id="boatSensDiv"></div>
			</div>
			<div id="maincenter">
				<div id="depth">??</div>
				<script>
					initAlarm(document.getElementById("maincenter"));
				</script>
				<canvas id="echoCanvas" width="556" height="400"></canvas>
				<div id="rangeScale"></div>
				<div id="timeScale"></div>
				<div id="nmeaPanel">
				<form id="nmeaOutputs">
				<div class="nmeaHeaderText">NMEA OUTPUTS:</div>
					<table>
					<tr><td width="30px">DPT:</td><td width="45px"><input type="checkbox" id="ch1" name="oms[]" value="a" onclick="onOutputsCheckboxEvent()"></input></td>
					<td width="30px">DBS:</td><td width="45px"><input type="checkbox" id="ch2" name="oms[]" value="b" onclick="onOutputsCheckboxEvent()"></input></td>
					<td width="30px">DBA:</td><td width="45px"><input type="checkbox" id="ch3" name="oms[]" value="c" onclick="onOutputsCheckboxEvent()"></input></td></tr>
					<tr><td width="30px">PSWP:</td><td width="45px"><input type="checkbox" id="ch4" name="oms[]" value="d" onclick="onOutputsCheckboxEvent()"></input></td>
					<td width="30px">XDR</td><td width="45px"><input type="checkbox" id="ch5" name="oms[]" value="e" onclick="onOutputsCheckboxEvent()"></input></td></tr> 
					</table>
				</form>
		
				
				
				<form id="comBaud">
				<div class="nmeaHeaderText">BAUD RATE:</div>
					<table>
					<tr><td width="30px">4800</td><td width="40px"><input type="radio" name="ba" onclick="onBaudChanged(0)" value=0></input></td>
					<td width="30px">9600</td><td width="40px"><input type="radio" name="ba" onclick="onBaudChanged(1)" value=1></input></td>
					<td width="30px">38400</td><td width="40px"><input type="radio" name="ba" onclick="onBaudChanged(2)" value=2></input></td>
					<td width="30px">115200</td><td width="40px"><input type="radio" name="ba" onclick="onBaudChanged(3)" value=3></input></td></tr> 
					</table>
				</form>
				
				<form id="diplayForm">
				<div class="nmeaHeaderText">DISPLAY</div>
					<table>
					<tr><td width="20px">OUT</td><td width="45px"><input type="radio" name="dis" onclick="onDisplayChanged(0)" value=0></input></td>
					<td width="20px">IN</td><td width="45px"><input type="radio" name="dis" onclick="onDisplayChanged(1)" value=1></input></td>
					<td width="20px">OFF</td><td width="45px"><input type="radio" name="dis" onclick="onDisplayChanged(2)" value=2></input></td></tr> 
					</table>
				</form>
				
				
				<div id="nmeaListDiv" border="1">
					
				<select id="nmeaList" size="17" multiple="multiple">
					<!--  	<option value="a" selected="selected">PPSKT, 0200,0,+00.0,0,0050,7,03,*41</option>
							<option value="b">$PPSKT, 0200,0,+00.0,0,0050,7,03,*41</option> -->
				</select>
		 		</div> 
		 		</div> <!-- nmeaPanel end -->
		 		<div id="day_night"></div>
				<div id="sliderChoice"></div>
				<div id="alarmMsgDiv"></div>
				<div id="transceiverDiv"></div>
				<div id="menuBar">
					<div id="menuOnOffBut" style="height: 100%; float: left"; onmouseover="onSetupButtonOver()"
						onmouseout="onSetupButtonOut()" onclick="onSetupButtonClick()" ;>Menu
					</div>
				
					<!--  <div id="mainChoiceText">Range</div>-->
					<div id="subMenu"></div>
				</div><!--  end menuBar -->
			
			<div id="statusDiv">STATUS
					<table>
					<tr><td class="sr1">+5V</td><td class="sr2">4.8V</td><td class="sr3">Frequency:</td><td class="sr4">50kHz</td><td class="sr3">Frequency:</td><td class="sr4">50kHz</td></tr>
					<tr><td class="sr1">+12V</td><td class="sr2">11.5V</td><td class="sr3">Depth range:</td><td class="sr4">50m</td><td class="sr3">Frequency:</td><td class="sr4">50kHz</td></tr>
					<tr><td class="sr1">Inv12V</td><td class="sr2">11.5V</td><td class="sr3"></td><td class="sr4">50m</td><td class="sr3">Frequency:</td><td class="sr4">50kHz</td></tr>
					<tr><td class="sr1">XCVR</td><td class="sr2">25.4V</td><td class="sr3"></td><td class="sr4">50m</td><td class="sr3">Frequency:</td><td class="sr4">50kHz</td></tr>
					</table>
				</div>
			</div><!--  end main -->

			<div id="eastsidebar">
				<div id="sigDiv"></div>
				<div id="eastContainer">
					
				</div>
				<div id="eastRange_Light">
						<div id="eastRangeButton"; onmouseover="onRangeButtonOver()"
						onmouseout="onRangeButtonOut()" onclick="onRangeButtonClick()";></div>
						<div id="eastLightButton";onmouseover="onLightButtonOver()"
						onmouseout="onLightButtonOut()" onclick="onLightButtonClick()";></div>
					</div>
			</div>

			

			<div id="rangeSliderDiv"></div>
		</div>
		<!-- container end -->

	</div>
	<!-- wrap end -->

	<script>
	
	// TODO
	function onOutputsCheckboxEvent(){
		var tempArray = new Array();
		if($('#ch1').attr('checked'))
			tempArray.push($('#ch1').attr('value'));
		if($('#ch2').attr('checked'))
			tempArray.push($('#ch2').attr('value'));
		if($('#ch3').attr('checked'))
			tempArray.push($('#ch3').attr('value'));
		if($('#ch4').attr('checked'))
			tempArray.push($('#ch4').attr('value'));
		if($('#ch5').attr('checked'))
			tempArray.push($('#ch5').attr('value'));
	
		jsonIO.set[selectedIO_source-1].oms = tempArray;
		//alert("source: " + (selectedIO_source-1) + ". " + JSON.stringify(jsonIO.set[selectedIO_source-1]));
		sendToServer(JSON.stringify(jsonIO.set[selectedIO_source-1]));
}

	function selectJsonRadioValue(selIndex){
		jsonIO.set[selectedIO_source-1].baudR.ba = selIndex;
		sendToServer(JSON.stringify(jsonIO.set[selectedIO_source-1]));
	}
	
	// baud rate pushed
	function onBaudChanged(selIndex){
		/*jsonBaud.baudR.ba = selIndex;
		sendToServer(JSON.stringify(jsonBaud));
		*/
		jsonIO.set[selectedIO_source-1].baudR.ba = selIndex;
		sendToServer(JSON.stringify(jsonIO.set[selectedIO_source-1]));
	}
	
	// Changed Displays "Input", "Output" or "Off" 
	function onDisplayChanged(selIndex){
		jsonIO.set[selectedIO_source-1].disRadio.dis = selIndex;
		if(selIndex == 0 || selIndex == 1){
			while(getListCount() > 0) { // TODO: remove all
				removeOptionLast();
			}
		}
			
		sendToServer(JSON.stringify(jsonIO.set[selectedIO_source-1]));
	}
	
	


	
		createLightDiv(document.getElementById("day_night"));
		
		$("#nmeaPanel").hide();
		$("#day_night").hide();
		$("#statusDiv").hide();
		$("#transceiverDiv").hide();
		
		changeRange(0);
		initVertMenu(document.getElementById("eastContainer"));//eastsidebar"));
		initMenu();
		$('#sliderChoice').hide();
		
		initTransceiver(document.getElementById("transceiverDiv"));
		
		var rangeText = [ "10", "50", "100", "500", "1200", "1600" ];
	
		var rangeSlider3 = new SliderVertical(100, "RANGE", 1, 100, 34,
				document.getElementById("rangeSliderDiv"), rangeText);//testCont"),rangeText);
		$("#rangeSliderDiv").hide();		
		//setSignalData();
				
		showAlarmMsg(false);
		$('#tableTest').populate(jsonTOP.myObject); //{'time':'12.22.12','gps':"11111",'speed':'144','frq':'100kHz'});	
		//$('#nmeaOutputs').populate(jsonOutputs.oms);
		$('#diplayForm').populate(jsonDisplay.disRadio);
		$('#comBaud').populate(jsonBaud.baudR);
		
		reconnectSocket();

		function reconnectSocket() {
			//if (conn.readyState === undefined || conn.readyState > 1) {
			//////// ECHO SOUNDER WEBSOCKET ////////
			echoWebSock = new MozWebSocket('ws://10.31.1.128/echo');

			echoWebSock.onopen = function() { //e
				//	alert("Connected");
			};
			echoWebSock.onmessage = function(msg) {
				parseEchoData(msg.data);
				
				//appendTxtNode(msg.data);
			};
			echoWebSock.onclose = function() { //e
				var clearArray = new Array();
			
				echoCanvas1.setNewData(clearArray);
				if (echoCanvas2 != null)
					echoCanvas2.setNewData(clearArray);
		
				alert("Lost connection");
			};

			echoWebSock.onerror = function(e) {
				alert("websocket error");
			};

			//////// DATA WEBSOCKET ////////
			dataWebSock = new MozWebSocket('ws://10.31.1.128/data');
			dataWebSock.onopen = function() { //e
					//alert("Connected dataWebSock");
			};
			dataWebSock.onmessage = function(msg) {
				parseRecData(msg.data);
				//appendTxtNode(msg.data);
			};
			dataWebSock.onclose = function() { //e
				alert("dataWebSock Lost connection");
			};

			dataWebSock.onerror = function(e) {
				alert("dataWebSock error: " + e);
			};

		}
	</script>

</body>
</html>


