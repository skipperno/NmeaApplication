
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xml:lang="en" lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Page-Enter" content="blendTrans(Duration=2)" />
<meta http-equiv="Site-Exit" content="blendTrans(Duration=5)" />



<link rel="stylesheet" type="text/css" href="Main.css" />
<link rel="stylesheet" type="text/css" href="Position.css" />
<link rel="stylesheet" type="text/css" href="Menu.css" />
<link rel="stylesheet" type="text/css" href="Other.css" />

<link rel="stylesheet" type="text/css" href="SliderHorizontal.css" />
<link rel="stylesheet" type="text/css" href="SliderVertical.css" />

<script src="jquery.js"></script>

<script type="text/javascript" src="SliderHorizontal.js"></script>
<script type="text/javascript" src="SliderVertical.js"></script>

<script type="text/javascript" src="Menu.js"></script>
<script type="text/javascript" src="MenuVertical.js"></script>
<script type="text/javascript" src="MenuHorizontal.js"></script>
<script type="text/javascript" src="MenuItem.js"></script>
<script type="text/javascript" src="Range.js"></script>
<script type="text/javascript" src="TimeScale.js"></script>
<script type="text/javascript" src="data.js"></script>
<script type="text/javascript" src="json2.js"></script>

<!-- """"""""""""""""""""""""""""""""""""""""""""""""""""""""" -->
<script type="text/javascript" src="swfobject.js"></script>
<script type="text/javascript" src="web_socket.js"></script>
<!-- """"""""""""""""""""""""""""""""""""""""""""""""""""""""" -->

<script src="EchoPainter.js"></script>
<script src="Scope.js"></script>


<title>Skippers</title>

<script type="text/javascript" charset="UTF-8">
	//ISO-8859-1">
	WEB_SOCKET_SWF_LOCATION = "WebSocketMain.swf";
	var conn = {};
	var echoWebSock; //echo sounder data
	var dataWebSock; // set-get data (e.q. GAIN, TVG...)

	var oldRange = 0;
	var currRange = 0;

	var currTimeScale = 0;

	var echoCanvas1;
	var echoCanvas1_x = 0;
	var echoCanvas1_y = 0;
	var echoCanvas2;
	var scopeCanvas;
	var scopeVisible = false;
	
	var CANVAS_WIDTH = 556;
	var CANVAS_HEIGHT = 400;
	
	var dataReceived = 0;
	var newColorArrayCh1;
	var newColorArrayCh2;
	var canvasWidth = CANVAS_WIDTH;
	var canvasHeight = CANVAS_HEIGHT;

	var chan = 1;

	window.onload = initEchoPainting;

	function initEchoPainting() {
		scopeCanvas = new Scope(0, 0, 400, 256);
		initOneCanvas();
		//startDataProviderTimer();*/
		startPaintingCanvasTimer();
		
	}

	function initOneCanvas() {
		echoCanvas1 = new EchoCanvas(echoCanvas1_x, echoCanvas1_y, canvasWidth, canvasHeight);
		echoCanvas2 = null;
		//echoCanvas1.resize(400, 0, 150, 450);
	}

	function initBothCanvas() {
		echoCanvas1 = new EchoCanvas(0, 0, 450, canvasHeight);
		echoCanvas2 = new EchoCanvas(450, 0, 450, canvasHeight);
	}
	
	function changeToScopeScreen() {
		scopeVisible = true;
		canvasWidth = 150;
		echoCanvas1.resize(406, 0, canvasWidth, canvasHeight);
	}
	
	function changeToEchoScreen() {
		scopeVisible = false;
		canvasWidth = CANVAS_WIDTH;
		canvasHeight = CANVAS_HEIGHT;
		echoCanvas1.resize(0, 0, canvasWidth, canvasHeight);
	}

	//////////////////////////////////////////////////
	//TIMER USED FOR ECHO PAINTING USING CANVAS
	//////////////////////////////////////////////////
	function startPaintingCanvasTimer() {
		t = setTimeout("onPaintingCanvasTimer()", startSleepTime + sleepCoef
				* 100); //300);
	}

	function onPaintingCanvasTimer() {
		if (dataReceived > 0) {
			if (scopeVisible)
				scopeCanvas.paint();
			echoCanvas1.echoPainter_PaintCanvas();
			if (echoCanvas2 != null)
				echoCanvas2.echoPainter_PaintCanvas();
		}
		startPaintingCanvasTimer();
	}

	//////////////////////////////////////////////////
	// TIMER USED FOR GETING OF SENSOR DATA FROM 
	// THE WEB SERVER.
	//////////////////////////////////////////////////
	/*function startDataProviderTimer() {
		t = setTimeout("onDataProviderTimer()", 1000);
	}

	////////////////////////////////////////////////
	// Get echo data from php
	////////////////////////////////////////////////
	function onDataProviderTimer() {
		$.get("dataProvider.php", // calling php
		{
			type : 1, // echo = 1, ...
			chan : chan, // 1 when 1 channel requested. 2 for 2 chanels
			range : currRange
		//
		}, // parameter to send
		function(data) { // callback function
			parseEchoData(data);
			//alert("ajax callback");
			//$('#timeval').html(data); // don't remove. It displays received message
		}

		); // end of "$get"

		startDataProviderTimer();
		///////////////////////////////////////////////
		// Don't remove: The same using jquery function "load"
		///////////////////////////////////////////////
		//$('#timeval').load('dataProvider.php?randval='+ Math.random());
	}*/

	/* !!! DON*T REMOVE THIS
	// some of sliders is moved. 
	function onSliderMoved(sliderIndex, pos) {
		pos = parseInt(pos / 10);
		if (pos > 5)
			pos = 5;
		
		

		if (sliderIndex == 2){
			reconnectSocket();
		} else if (sliderIndex == 3){
			changeTimeRange(pos);
		} else if (sliderIndex == 4) {
			sendToServer("R" + pos);
		}
	}
	 */
	////////////////////////////////////////////////
	// Parse echo data received from server
	////////////////////////////////////////////////
	function parseEchoData(data) {
		
		if (data.charAt(0) == '1') { //MSG TYPE = ECHO_
			var range = data.charAt(1);

			if (currRange != range) {
				oldRange = currRange;
				currRange = range;
				echoCanvas1.paintChangedRange(oldRange);
				changeRange(currRange);
			}


			var chanelsArray = data.substring(2).split("CH"); // NOT USED YET
			newColorArrayCh1 = chanelsArray[0].split(",");
			if (chanelsArray.length > 1) // NOT USED, ALWAYS = 1
				newColorArrayCh2 = chanelsArray[1].split(",");
			
			var buttom = newColorArrayCh1[0];
			document.getElementById("depth").innerHTML = "" + buttom + "m";
			
			dataReceived = 1;
			
			if (scopeVisible)
				scopeCanvas.setNewData(newColorArrayCh1);
			echoCanvas1.setNewData(newColorArrayCh1);
			if (echoCanvas2 != null)
				echoCanvas2.setNewData(newColorArrayCh2);
			//startDataProviderTimer(); // if you start timer from here, it will take 500ms (timer time) + around 500ms for sending/receiving of data
		}
	}
	
	
	function parseRecData(data){
		jsonDATA = JSON.parse(data);//, reviver);
		setSignalData();
	}
	
	function sendToServer(msgToServer) {
		dataWebSock.send(msgToServer);// + "\n");
	}
</script>
</head>

<body>
	<div id="wrap">
		<div id="container">

			<div class="northsidebar"></div>
			<div id="maincenter">
				<div id="depth">??</div>
				<canvas id="echoCanvas" width="556" height="400"></canvas>
				<div id="rangeScale"></div>
				<div id="timeScale"></div>
				<div id="sliderChoice"></div>
			</div>

			<div id="eastsidebar">
				<div id="sss" style="margin: 0px auto; width: 60px;"></div>
			</div>

			<div id="menuBar">
				<div id="menuOnOffBut" style="height: 100%; float: left">
					<img src="images/menu.png" class="centerImg" id="enbMenuBut"
						width="60" height="60" onmouseover="onSetupButtonOver()"
						onmouseout="onSetupButtonOut()" onclick="onSetupButtonClick()" ;/>
				</div>
				<!--  <div id="mainChoiceText">Range</div>-->
				<div id="subMenu"></div>
				<img src="images/boat_40_2.png"
					style="float: right; margin-right: 10px;" width="62" height="40" />
				<!-- </div> -->
			</div>

			<div id="rangeSliderDiv"></div>
		</div>
		<!-- container end -->

	</div>
	<!-- wrap end -->

	<script>
		changeRange(0);
		initVertMenu(document.getElementById("sss"));//eastsidebar"));
		initMenu();
		$('#sliderChoice').hide();
		//showVertMenu(false);

		var rangeText = [ "10", "50", "100", "500", "1200", "1600" ];
		//var rangeSlider2 = new SliderVertical(1,1,100, 34,  document.getElementById("sss"),rangeText);//testCont"),rangeText);
		var rangeSlider3 = new SliderVertical(100, "RANGE", 1, 100, 34,
				document.getElementById("rangeSliderDiv"), rangeText);//testCont"),rangeText);
				
				setSignalData();
				
		reconnectSocket();

		function reconnectSocket() {
			//if (conn.readyState === undefined || conn.readyState > 1) {
			//////// ECHO SOUNDER WEBSOCKET ////////
			echoWebSock = new WebSocket('ws://10.31.1.119/echo');

			echoWebSock.onopen = function() { //e
				//	alert("Connected");
			};
			echoWebSock.onmessage = function(msg) {
				parseEchoData(msg.data);
				
				//appendTxtNode(msg.data);
			};
			echoWebSock.onclose = function() { //e
				var clearArray = new Array();
			
				echoCanvas1.setNewData(clearArray);
				if (echoCanvas2 != null)
					echoCanvas2.setNewData(clearArray);
		
				alert("Lost connection");
			};

			echoWebSock.onerror = function(e) {
				alert("websocket error");
			};

			//////// DATA WEBSOCKET ////////
			dataWebSock = new WebSocket('ws://10.31.1.119/data');
			dataWebSock.onopen = function() { //e
					//alert("Connected dataWebSock");
			};
			dataWebSock.onmessage = function(msg) {
				parseRecData(msg.data);
				//appendTxtNode(msg.data);
			};
			dataWebSock.onclose = function() { //e
				alert("dataWebSock Lost connection");
			};

			dataWebSock.onerror = function(e) {
				alert("dataWebSock error: " + e);
			};

		}
	</script>

</body>
</html>


